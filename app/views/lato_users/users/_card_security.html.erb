<div class="card mb-4">
  <div class="card-header">
    <h2 class="fs-4 mb-0"><%= I18n.t('lato_users.security') %></h2>
  </div>
  <div class="card-body">
    <% if Lato.config.authenticator_connection || Lato.config.webauthn_connection %>
      <div class="row mb-4">
        <div class="col-12">
          <div class="list-group">
            <% if Lato.config.authenticator_connection %>
              <div class="list-group-item p-3">
                <div class="row align-items-center">
                  <div class="col">
                    <span class="fw-bold"><%= I18n.t('lato_users.authenticator_connection') %></span>
                  </div>
                  <div class="col-auto">
                    <% if @user.authenticator_secret.present? %>
                      <span class="badge bg-success"><%= I18n.t('lato_users.connected') %></span>
                    <% else %>
                      <span class="badge bg-secondary"><%= I18n.t('lato_users.not_connected') %></span>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>

            <% if Lato.config.webauthn_connection %>
              <div class="list-group-item p-3">
                <div class="row align-items-center">
                  <div class="col">
                    <span class="fw-bold"><%= I18n.t('lato_users.webauthn_connection') %></span>
                  </div>
                  <div class="col-auto">
                    <span class="badge bg-primary">
                      <%= I18n.t('lato_users.devices_count') %>: <%= @user.webauthn_public_key.present? ? 1 : 0 %>
                    </span>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <div class="row mb-4">
      <div class="col-12">
        <h5 class="fs-6 fw-bold mb-3"><%= I18n.t('lato_users.signup_logs') %></h5>
        <% if @user.lato_log_user_signups.any? %>
          <div class="list-group">
            <% @user.lato_log_user_signups.order(created_at: :desc).limit(5).each do |log| %>
              <div class="list-group-item p-3">
                <div class="row align-items-center gy-2">
                  <div class="col-12 col-md-3 text-muted small">
                    <i class="bi bi-calendar-event me-2"></i>
                    <%= l(log.created_at, format: :long) %>
                  </div>
                  <div class="col-12 col-md-3">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-globe me-2 text-muted d-md-none"></i>
                      <code class="text-dark"><%= log.ip_address %></code>
                    </div>
                  </div>
                  <div class="col-12 col-md-6 text-muted small">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-laptop me-2 d-md-none"></i>
                      <span class="text-truncate d-block" style="max-width: 100%;" title="<%= log.user_agent %>" data-bs-toggle="tooltip">
                        <%= log.user_agent %>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="alert alert-light border text-center text-muted">
            <i class="bi bi-info-circle me-2"></i><%= I18n.t('lato_users.no_logs_found') %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-12">
        <h5 class="fs-6 fw-bold mb-3"><%= I18n.t('lato_users.login_logs') %></h5>
        <% if @user.lato_log_user_signins.any? %>
          <div class="list-group">
            <% @user.lato_log_user_signins.order(created_at: :desc).limit(5).each do |log| %>
              <div class="list-group-item p-3">
                <div class="row align-items-center gy-2">
                  <div class="col-12 col-md-3 text-muted small">
                    <i class="bi bi-calendar-event me-2"></i>
                    <%= l(log.created_at, format: :long) %>
                  </div>
                  <div class="col-12 col-md-3">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-globe me-2 text-muted d-md-none"></i>
                      <code class="text-dark"><%= log.ip_address %></code>
                    </div>
                  </div>
                  <div class="col-12 col-md-6 text-muted small">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-laptop me-2 d-md-none"></i>
                      <span class="text-truncate d-block" style="max-width: 100%;" title="<%= log.user_agent %>" data-bs-toggle="tooltip">
                        <%= log.user_agent %>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="alert alert-light border text-center text-muted">
            <i class="bi bi-info-circle me-2"></i><%= I18n.t('lato_users.no_logs_found') %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <h5 class="fs-6 fw-bold mb-3"><%= I18n.t('lato_users.password_management') %></h5>
        
        <% if @user.password_digest.present? %>
          <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between p-3 bg-success bg-opacity-10 border border-success rounded">
            <div class="d-flex align-items-center mb-3 mb-md-0">
              <div class="me-3 text-success">
                <i class="bi bi-shield-lock-fill fs-4"></i>
              </div>
              <div>
                <h5 class="fs-6 fw-bold text-success mb-0"><%= I18n.t('lato_users.password_set') %></h5>
              </div>
            </div>
            <div class="d-flex gap-2">
              <%= button_to force_update_password_user_path(@user), method: :patch, class: "btn btn-danger btn-sm d-flex align-items-center", form: { data: { turbo_confirm: I18n.t('lato_users.are_you_sure') } } do %>
                <%= I18n.t('lato_users.force_password_update') %>
              <% end %>
            </div>
          </div>
        <% else %>
          <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between p-3 bg-danger bg-opacity-10 border border-danger rounded">
            <div class="d-flex align-items-center mb-3 mb-md-0">
              <div class="me-3 text-danger">
                <i class="bi bi-shield-exclamation fs-4"></i>
              </div>
              <div>
                <h5 class="fs-6 fw-bold text-danger mb-0"><%= I18n.t('lato_users.password_not_set') %></h5>
              </div>
            </div>
            <div class="d-flex gap-2">
              <%= button_to force_update_password_user_path(@user), method: :patch, class: "btn btn-danger btn-sm d-flex align-items-center", form: { data: { turbo_confirm: I18n.t('lato_users.are_you_sure') } } do %>
                <%= I18n.t('lato_users.force_password_update') %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
